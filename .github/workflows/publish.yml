name: Release

on:
    push:
      tags:
        - 'v*'

permissions:
  contents: write


env:
  name: 'Desomnia'

  VERSION_NET: '9.0'
  VERSION_DESOMNIA: ${{ github.ref_name }}

jobs:

  build-plugins:
    name: Build Desomnia plugin
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # name: [ FirewallKnockOperator ]
        name: [ DuoStreamIntegration, HyperVSupport, FirewallKnockOperator ]

        include:
          - name: DuoStreamIntegration
            os: -windows8.0
          - name: HyperVSupport
            os: -windows8.0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '${{ env.VERSION_NET }}.x'

      - name: Publish ${{ matrix.name }}
        run: |
          dotnet publish plugins/${{ matrix.name }}/${{ matrix.name }}.csproj \
            -o ${{ runner.temp }}/publish/${{ matrix.name }} \
            -f net${{ env.VERSION_NET }}${{ matrix.os }} \
            -c Release \
            --no-self-contained \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            -p:PublishSingleFile=false

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-${{ matrix.name }}
          path:  ${{ runner.temp }}/publish/
          if-no-files-found: error

  build-linux:
    name: Build DesomniaDaemon
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [ arm64, x64 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '${{ env.VERSION_NET }}.x'
          
      - name: Publish DesomniaDaemon (${{ matrix.arch }})
        run: |
          dotnet publish DesomniaDaemon/DesomniaDaemon.csproj \
            -o ${{ runner.temp }}/publish \
            -f net${{ env.VERSION_NET }} \
            -c Release \
            -r linux-${{ matrix.arch }} \
            --no-self-contained \
            -p:DebugSymbols=false \
            -p:PublishSingleFile=true \
            -p:PublishReadyToRun=true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux_${{ matrix.arch }}
          path:  ${{ runner.temp }}/publish/desomniad
          if-no-files-found: error

  build-macos:
    name: Build DesomniaLaunchDaemon
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [ arm64, x64 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '${{ env.VERSION_NET }}.x'
          
      - name: Publish DesomniaLaunchDaemon (${{ matrix.arch }})
        run: |
          dotnet publish DesomniaLaunchDaemon/DesomniaLaunchDaemon.csproj \
            -o ${{ runner.temp }}/publish \
            -f net${{ env.VERSION_NET }} \
            -c Release \
            -r osx-${{ matrix.arch }} \
            --no-self-contained \
            -p:DebugSymbols=false \
            -p:PublishSingleFile=true \
            -p:PublishReadyToRun=true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos_${{ matrix.arch }}
          path:  ${{ runner.temp }}/publish/desomniad
          if-no-files-found: error

  build-windows:
    name: Build DesomniaService
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [ arm64, x64 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '${{ env.VERSION_NET }}.x'
          
      - name: Publish DesomniaService (${{ matrix.arch }})
        run: |
          dotnet publish DesomniaService/DesomniaService.csproj \
            -o ${{ runner.temp }}/publish \
            -f net${{ env.VERSION_NET }}-windows8.0 \
            -c Release \
            -r win-${{ matrix.arch }} \
            --no-self-contained \
            -p:DebugSymbols=false \
            -p:PublishSingleFile=false

      - name: Publish DesomniaServiceHelper (${{ matrix.arch }})
        run: |
          dotnet publish helper/DesomniaServiceHelper/DesomniaServiceHelper.csproj \
            -o ${{ runner.temp }}/publish \
            -f net${{ env.VERSION_NET }}-windows8.0 \
            -c Release \
            -r win-${{ matrix.arch }} \
            --no-self-contained \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            -p:PublishSingleFile=true \
            -p:PublishReadyToRun=true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows_${{ matrix.arch }}
          path:  ${{ runner.temp }}/publish/
          if-no-files-found: error

  release:
    name: Create Release
    needs: [ build-plugins, build-windows, build-macos, build-linux ]
    runs-on: ubuntu-latest
    steps:
      # Download everything you want to publish as release assets
      # - name: Download windows installer
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: windows_installer
      #     path: ${{ runner.temp }}

      # (Optional) If you need to re-zip folders into single distributables, do it here. 

      - name: Download main artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*_{x64,arm64}"
          path: ${{ runner.temp }}/main
      - name: Download plugin artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: plugin-*
          path: ${{ runner.temp }}/plugins
          merge-multiple: true

      - name: Create platform-specific archives
        shell: bash
        run: |
          VERSION="${{ env.VERSION_DESOMNIA }}"
          VERSION="${VERSION#v}"

          cd ${{ runner.temp }}/main
          
          for platform in windows linux macos; do
            for dir in ${platform}_*/; do
              if [ -d "$dir" ]; then
                arch="${dir%/}"
                arch="${arch#${platform}_}"

                out="${{ runner.temp }}/Desomnia_${VERSION}_${platform}-${arch}.zip"

                (
                  cd "$dir" || exit 1
                  # zip the *contents* of the dir, not the dir itself
                  zip -r "$out" .
                )
              fi
            done
          done

          # Create universal macOS archive with both architectures
          if [ -d "macos_x64" ] && [ -d "macos_arm64" ]; then
            mkdir -p "${{ runner.temp }}/macos_universal"
            cp -r macos_x64/* "${{ runner.temp }}/macos_universal/x64/"
            cp -r macos_arm64/* "${{ runner.temp }}/macos_universal/arm64/"
            (
              cd "${{ runner.temp }}/macos_universal"
              zip -r "${{ runner.temp }}/Desomnia_${VERSION}_macos.zip" .
            )
          fi

          cd ${{ runner.temp }}/plugins

          for plugin_dir in */; do
            if [ -d "$plugin_dir" ]; then
              plugin_name="${plugin_dir%/}"
              zip -r "${{ runner.temp }}/plugin-${plugin_name}_${VERSION}.zip" "$plugin_dir"
            fi
          done

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') }}
          #generate_release_notes: true
          files: |
            ${{ runner.temp }}/Desomnia_*
            ${{ runner.temp }}/plugin-*.zip

  # release-homebrew:
  #   name: Bump Homebrew formula
  #   needs: [ release ]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Extract version
  #       id: version
  #       run: |
  #         TAG="${GITHUB_REF_NAME}"     # v3.0.0-beta5
  #         VERSION="${TAG#v}"           # 3.0.0-beta5
  #         echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  #     - name: Bump Homebrew formula in custom tap
  #       uses: mislav/bump-homebrew-formula-action@v3
  #       with:
  #         formula-name: desomnia
  #         homebrew-tap: mad0x20wizard/homebrew-tools
  #         # If your asset name follows your tag, you can compute the URL like this:
  #         download-url: https://github.com/mad0x20wizard/Desomnia-Test/releases/download/${{ github.ref_name }}/Desomnia_${{ steps.version.outputs.version }}_macos.zip
  #       env:
  #         COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}