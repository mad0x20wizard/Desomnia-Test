name: Release

on:
    push:
      tags:
        - 'v*'

permissions:
  contents: write


env:
  name: 'Desomnia'

  VERSION_NET: '9.0'
  VERSION_DESOMNIA: ${{ github.ref_name }}

jobs:

  build-linux:
    name: Build DesomniaDaemon
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [ arm64, x64 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '${{ env.VERSION_NET }}.x'
          
      - name: Publish DesomniaDaemon (${{ matrix.arch }})
        run: |
          dotnet publish DesomniaDaemon/DesomniaDaemon.csproj \
            -o ${{ runner.temp }}/publish \
            -f net${{ env.VERSION_NET }} \
            -c Release \
            -r linux-${{ matrix.arch }} \
            --no-self-contained \
            -p:DebugSymbols=false \
            -p:PublishSingleFile=true \
            -p:PublishReadyToRun=true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux_${{ matrix.arch }}
          path:  ${{ runner.temp }}/publish/desomniad
          if-no-files-found: error

  build-macos:
    name: Build DesomniaLaunchDaemon
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [ arm64, x64 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '${{ env.VERSION_NET }}.x'
          
      - name: Publish DesomniaLaunchDaemon (${{ matrix.arch }})
        run: |
          dotnet publish DesomniaLaunchDaemon/DesomniaLaunchDaemon.csproj \
            -o ${{ runner.temp }}/publish \
            -f net${{ env.VERSION_NET }} \
            -c Release \
            -r osx-${{ matrix.arch }} \
            --no-self-contained \
            -p:DebugSymbols=false \
            -p:PublishSingleFile=true \
            -p:PublishReadyToRun=true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos_${{ matrix.arch }}
          path:  ${{ runner.temp }}/publish/desomniad
          if-no-files-found: error

  build-windows:
    name: Build DesomniaService
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [ arm64, x64 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '${{ env.VERSION_NET }}.x'
          
      - name: Publish DesomniaService (${{ matrix.arch }})
        run: |
          dotnet publish DesomniaService/DesomniaService.csproj \
            -o ${{ runner.temp }}/publish \
            -f net${{ env.VERSION_NET }}-windows8.0 \
            -c Release \
            -r win-${{ matrix.arch }} \
            --no-self-contained \
            -p:DebugSymbols=false \
            -p:PublishSingleFile=false

      - name: Publish DesomniaServiceHelper (${{ matrix.arch }})
        run: |
          dotnet publish helper/DesomniaServiceHelper/DesomniaServiceHelper.csproj \
            -o ${{ runner.temp }}/publish \
            -f net${{ env.VERSION_NET }}-windows8.0 \
            -c Release \
            -r win-${{ matrix.arch }} \
            --no-self-contained \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            -p:PublishSingleFile=true \
            -p:PublishReadyToRun=true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows_${{ matrix.arch }}
          path:  ${{ runner.temp }}/publish/
          if-no-files-found: error

  release:
    name: Create Release
    needs: [ build-windows, build-macos, build-linux ]
    runs-on: ubuntu-latest
    steps:
      # Download everything you want to publish as release assets
      # - name: Download windows installer
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: windows_installer
      #     path: ${{ runner.temp }}

      # (Optional) If you need to re-zip folders into single distributables, do it here. 

      - name: Download main artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*_{x64,arm64}"
          path: ${{ runner.temp }}/main
          merge-multiple: true

      - name: Create platform-specific archives
        shell: bash
        run: |
          VERSION="${{ env.VERSION_DESOMNIA }}"
          VERSION="${VERSION#v}"

          cd ${{ runner.temp }}/main
          
          for platform in windows linux macos; do
            for dir in ${platform}_*/; do
              if [ -d "$dir" ]; then
                arch="${dir%/}"
                arch="${arch#${platform}_}"
                zip -r "${{ runner.temp }}/Desomnia_${platform}_${VERSION}_${arch}.zip" "$dir"
              fi
            done
          done

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') }}
          #generate_release_notes: true
          files: |
            ${{ runner.temp }}/Desomnia_*
